name: Update README with Repositories

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Fetch Repositories and Update README
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const username = context.repo.owner;
            
            const { data: repos } = await github.rest.repos.listForUser({
              username: username,
              sort: 'updated',
              per_page: 50, // ‡¶™‡ßç‡¶∞‡¶´‡ßá‡¶∂‡¶®‡¶æ‡¶≤ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßá‡¶∞‡¶æ ‡ß´‡ß¶‡¶ü‡¶ø ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü
              type: 'public'
            });
            
            // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ø‡¶Ç: ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶´‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ
            const filteredRepos = repos.filter(repo => repo.name !== username && !repo.fork);
            
            let projectsHtml = '<div align="center">\n\n';
            projectsHtml += '<h2>üóÇÔ∏è My Open Source Projects</h2>\n\n';
            projectsHtml += '<table>\n';
            
            // ‡ß® ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã (Responsive Look)
            for (let i = 0; i < filteredRepos.length; i += 2) {
              projectsHtml += '<tr>\n';
              for (let j = 0; j < 2; j++) {
                const repo = filteredRepos[i + j];
                if (repo) {
                  const description = repo.description || 'No description available for this project.';
                  // ‡¶™‡¶ø‡¶® ‡¶è‡¶™‡¶ø‡¶Ü‡¶á ‡¶è‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü‡¶∞‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶è‡¶™‡¶ø‡¶Ü‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
                  const cardUrl = `https://github-readme-stats.vercel.app/api/pin/?username=${username}&repo=${repo.name}&theme=tokyonight&border_radius=10`;
                  
                  projectsHtml += `<td width="50%" align="center">
                  <a href="${repo.html_url}" target="_blank">
                    <img src="${cardUrl}" alt="${repo.name}" style="max-width:100%; border-radius:10px;" />
                  </a>
                  <br/>
                  <strong>${repo.name}</strong><br/>
                  <img src="https://img.shields.io/github/stars/${username}/${repo.name}?style=flat-square&label=Stars&color=yellow" />
                  <img src="https://img.shields.io/github/languages/top/${username}/${repo.name}?style=flat-square&color=blue" />
                  </td>\n`;
                } else {
                  projectsHtml += '<td width="50%"></td>\n';
                }
              }
              projectsHtml += '</tr>\n';
            }
            
            projectsHtml += '</table>\n\n';
            projectsHtml += `<sub>‚ú® Last Synchronized: ${new Date().toLocaleString('en-GB', { timeZone: 'Asia/Dhaka', dateStyle: 'medium', timeStyle: 'short' })} (BST)</sub>\n\n`;
            projectsHtml += '</div>\n';
            
            let readme = fs.readFileSync('README.md', 'utf8');
            const startMarker = '';
            const endMarker = '';
            const startIndex = readme.indexOf(startMarker);
            const endIndex = readme.indexOf(endMarker);
            
            if (startIndex !== -1 && endIndex !== -1) {
              const before = readme.substring(0, startIndex + startMarker.length);
              const after = readme.substring(endIndex);
              readme = before + '\n' + projectsHtml + after;
              fs.writeFileSync('README.md', readme);
              console.log('‚úÖ Success: README updated!');
            } else {
              console.log('‚ö†Ô∏è Error: HTML Markers not found in README.md');
            }
      
      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "ü§ñ Auto-update: Refreshed project gallery" && git push)
