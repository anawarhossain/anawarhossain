name: Update README with Pinned Repositories

on:
  schedule:
    - cron: '0 18 * * *' # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶∏‡¶Æ‡ßü ‡¶∞‡¶æ‡¶§ ‡ßß‡ß®‡¶ü‡¶æ‡ßü (UTC 18:00)
  workflow_dispatch: 
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶≤‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch Pinned Repositories and Update README
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // GraphQL Query: ‡¶™‡¶ø‡¶® ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡ßã‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
            const query = `
              query($username: String!) {
                user(login: $username) {
                  pinnedItems(first: 6, types: REPOSITORY) {
                    nodes {
                      ... on Repository {
                        name
                        description
                        html_url
                        stargazerCount
                        forkCount
                      }
                    }
                  }
                }
              }
            `;

            const username = context.repo.owner;
            const result = await github.graphql(query, { username: username });
            const pinnedRepos = result.user.pinnedItems.nodes;

            // HTML ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            let projectsHtml = '<div align="center">\n\n';
            projectsHtml += '<h2>üìå Featured Projects</h2>\n\n';
            projectsHtml += '<table>\n';

            for (let i = 0; i < pinnedRepos.length; i += 3) {
              projectsHtml += '<tr>\n';
              for (let j = 0; j < 3; j++) {
                const repo = pinnedRepos[i + j];
                if (repo) {
                  const desc = repo.description || 'No description available';
                  projectsHtml += `<td width="33%" align="center">
                  <a href="${repo.html_url}" target="_blank">
                    <img src="https://github-readme-stats.vercel.app/api/pin/?username=${username}&repo=${repo.name}&theme=tokyonight&show_owner=false" />
                  </a><br/>
                  <sub>${desc.substring(0, 50)}${desc.length > 50 ? '...' : ''}</sub><br/>
                  <img src="https://img.shields.io/github/stars/${username}/${repo.name}?style=social" />
                  <img src="https://img.shields.io/github/forks/${username}/${repo.name}?style=social" />
                  </td>\n`;
                } else {
                  projectsHtml += '<td width="33%"></td>\n';
                }
              }
              projectsHtml += '</tr>\n';
            }

            projectsHtml += '</table>\n\n';
            projectsHtml += `<sub>‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ${new Date().toLocaleString('en-US', { timeZone: 'Asia/Dhaka', dateStyle: 'full', timeStyle: 'short' })}</sub>\n\n`;
            projectsHtml += '</div>\n';

            // README.md ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            try {
              let readme = fs.readFileSync('README.md', 'utf8');
              const startMarker = '';
              const endMarker = '';
              const startIndex = readme.indexOf(startMarker);
              const endIndex = readme.indexOf(endMarker);

              if (startIndex !== -1 && endIndex !== -1) {
                const before = readme.substring(0, startIndex + startMarker.length);
                const after = readme.substring(endIndex);
                const finalReadme = before + '\n' + projectsHtml + after;
                fs.writeFileSync('README.md', finalReadme);
              } else {
                throw new Error('README.md ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞ (PROJECTS_START) ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!');
              }
            } catch (err) {
              core.setFailed(err.message);
            }

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "ü§ñ Auto-update: Pinned repository cards" && git push)
